{% extends "base_permits.html" %}

{% load i18n %}
{% load bootstrap4 %}
{% load permits_extras %}

{% block content-no-sidebar %}
  <div class="container">
    <h1>{% blocktrans with request_id=permit_request.pk %}Demande #{{ request_id }}{% endblocktrans %}</h1>
    <p title="">
    </p>
    {% if has_validations and nb_pending_validations == 0 or permit_request.status == 2 %}
      {% if perms.permits.amend_permit_request %}
        <a class="btn btn-outline-primary" href="{% url 'permits:printpdf' permit_request_id=permit_request.pk %}" class="mr-2">{% trans "Imprimer" %}</a>
      {% endif %}
    {% endif %}
    <dl>
      <dt>{% trans "Date de création" %}</dt>
      <dd title="{{ permit_request.created_at }}">
        {% blocktrans with request_date=permit_request.created_at|timesince %}Il y a {{ request_date }}{% endblocktrans %}
      </dd>
      <dt>{% trans "Statut" %}</dt>
      <dd>{{ permit_request.get_status_display }}</dd>
      <dt>{% trans "Auteur-e" %}</dt>
      <dd>
        <a href="mailto:{{ permit_request.author }} <{{ permit_request.author.email }}>" target="_blank">
          {{ permit_request.author }} &lt;{{ permit_request.author.email }}&gt;
        </a>
      </dd>
    </dl>
    {% permit_request_summary permit_request %}

    {% if forms.amend or forms.request_validation or forms.validate or forms.poke %}
      <h2>{% trans "Actions" %}</h2>
      <ul class="nav nav-tabs" id="actions-tabs" role="tablist">
        {% if forms.amend %}
          <li class="nav-item">
            <a class="nav-link{% if active_form == "amend" %} active{% endif %}" id="amend-tab" data-toggle="tab" href="#amend" role="tab" aria-controls="amend" aria-selected="{% if active_form == "amend" %}true{% else %}false{% endif %}">{% trans "Amender" %}</a>
          </li>
        {% endif %}

        {% if forms.request_validation %}
          <li class="nav-item">
            <a class="nav-link{% if active_form == "request_validation" %} active{% endif %}" id="request-validation-tab" data-toggle="tab" href="#request-validation" role="tab" aria-controls="request-validation" aria-selected="{% if active_form == "request_validation" %}true{% else %}false{% endif %}">{% trans "Envoyer pour validation" %}</a>
          </li>
        {% endif %}

        {% if forms.validate %}
          <li class="nav-item">
            <a class="nav-link{% if active_form == "validate" %} active{% endif %}" id="validate-tab" data-toggle="tab" href="#validate" role="tab" aria-controls="validate" aria-selected="{% if active_form == "validate" %}true{% else %}false{% endif %}">
              {% trans "Valider" %}
            </a>
          </li>
        {% endif %}

        {% if forms.poke %}
          <li class="nav-item">
            <a class="nav-link{% if active_form == "poke" %} active{% endif %}" id="classify-tab" data-toggle="tab" href="#classify" role="tab" aria-controls="classify" aria-selected="{% if active_form == "poke" %}true{% else %}false{% endif %}">
              {% trans "Classer" %}
            </a>
          </li>
        {% endif %}
      </ul>
      <div class="pt-3 tab-content box box--default box--tabbed">
        {% if forms.amend %}
          <div class="tab-pane{% if active_form == "amend" %} show active{% endif %}" id="amend" role="tabpanel" aria-labelledby="amend-tab">
            <form method="post">
              {% csrf_token %}

              {% bootstrap_form forms.amend layout='horizontal' %}

              <div class="text-right">
                <input name="action" type="hidden" value="amend">
                <button class="btn btn-primary">{% trans "Amender" %}</button>
              </div>
            </form>
          </div>
        {% endif %}

        {% if forms.request_validation %}
          <div class="tab-pane{% if active_form == "request_validation" %} show active{% endif %}" id="request-validation" role="tabpanel" aria-labelledby="request-validation-tab">
            <form method="post">
              {% csrf_token %}

              {% bootstrap_form forms.request_validation layout='horizontal' %}

              <div class="text-right">
                <input name="action" type="hidden" value="request_validation">
                <button class="btn btn-primary">{% trans "Envoyer pour validation" %}</button>
              </div>
            </form>
          </div>
        {% endif %}

        {% if forms.validate %}
          <div class="tab-pane{% if active_form == "validate" %} show active{% endif  %}" id="validate" role="tabpanel" aria-labelledby="validate-tab">
            <form method="post">
              {% csrf_token %}

              {% bootstrap_form forms.validate layout='horizontal' %}

              <div class="text-right">
                <input name="action" type="hidden" value="validate">
                <button class="btn btn-primary">{% trans "Valider" %}</button>
              </div>
            </form>
          </div>
        {% endif %}

        {% if forms.poke %}
          <div class="tab-pane{% if active_form == "poke" %} show active{% endif  %}" id="classify" role="tabpanel" aria-labelledby="classify-tab">
            <form method="post">
              {% csrf_token %}

              <dl>
              {% for validation in validations %}
                <dt>{{ validation.department.group.name }}</dt>
                <dd{% if validation.is_pending %} class="text-muted"{% endif %}>{{ validation.get_validation_status_display }}</dd>
              {% endfor %}
              </dl>
              {% if nb_pending_validations %}
                <div class="text-right">
                  <input name="action" type="hidden" value="poke">
                  <button class="btn btn-primary">
                    {% blocktrans trimmed count counter=nb_pending_validations %}
                      Envoyer un rappel au service
                    {% plural %}
                      Envoyer des rappels à {{ counter }} services
                    {% endblocktrans %}
                  </button>
                </div>
              {% endif %}
            </form>
          </div>
        {% endif %}
      </div>
    {% endif %}

    <p class="mt-4">
      <a href="{% url 'permits:permit_requests_list' %}">{% trans "Retour à la liste des demandes" %}</a>
    </p>
  </div>
{% endblock %}
